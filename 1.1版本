// ==UserScript==
// @name         NodeSeek ç­¾åˆ°è¿åŠ¿ç»Ÿè®¡
// @name:zh-CN   NodeSeek ç­¾åˆ°è¿åŠ¿ç»Ÿè®¡
// @namespace    https://www.nodeseek.com/
// @version      1.4
// @description  è‡ªåŠ¨ç»Ÿè®¡ NodeSeek å†å²ç­¾åˆ°æ•°æ®ï¼Œåˆ†ææ¬§çš‡æŒ‡æ•°ã€‚ä¸¥æ ¼è¿‡æ»¤â€œç­¾åˆ°æ”¶ç›Šâ€ï¼Œæ’é™¤è´Ÿæ•°ã€‚æ–°å¢â€œæ¿€è¿›æ´¾â€ä¸â€œä¿å®ˆæ´¾â€è¯„çº§ï¼Œå¼ºåŒ–IDæŠ“å–ã€‚
// @author       Modified by AI
// @match        https://www.nodeseek.com/member/log*
// @match        https://nodeseek.com/member/log*
// @match        https://www.nodeseek.com/credit*
// @match        https://nodeseek.com/credit*
// @icon         https://www.nodeseek.com/static/image/favicon/android-chrome-192x192.png
// @grant        GM_setClipboard
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    const KEY_DATA = 'ns_signin_data_v4';
    const KEY_STATE = 'ns_signin_state_v4';

    // çŠ¶æ€ç®¡ç†
    let state = JSON.parse(localStorage.getItem(KEY_STATE)) || {
        isRunning: false,
        targetPage: 0,
        maxPage: 1,
        startPage: 1
    };
    let allRecords = JSON.parse(localStorage.getItem(KEY_DATA)) || [];

    // --- å…¥å£ ---
    window.addEventListener('load', () => {
        setTimeout(() => {
            injectStyles();
            initBtn();
            if (state.isRunning) {
                createControlPanel();
                processPage();
            }
        }, 1500);
    });

    // --- 1. æ ·å¼æ³¨å…¥ ---
    function injectStyles() {
        if (document.getElementById('ns-style')) return;
        const style = document.createElement('style');
        style.id = 'ns-style';
        style.innerHTML = `
            :root {
                --ns-bg: rgba(255, 255, 255, 0.98);
                --ns-primary: #FF9500;
                --ns-text: #1d1d1f;
                --ns-subtext: #86868b;
                --ns-border: #d2d2d7;
            }
            .ns-panel {
                position: fixed; top: 100px; right: 20px; width: 360px;
                background: var(--ns-bg); backdrop-filter: blur(12px);
                border: 1px solid rgba(0,0,0,0.1); border-radius: 18px;
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                padding: 24px; z-index: 99999; display: flex; flex-direction: column;
                animation: ns-fade 0.3s ease-out; color: var(--ns-text);
            }
            @keyframes ns-fade { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

            .ns-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
            .ns-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
            .ns-close { cursor: pointer; color: var(--ns-subtext); font-size: 22px; transition: 0.2s; line-height: 1; }
            .ns-close:hover { color: var(--ns-text); }

            .ns-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
            .ns-stat { background: #f5f5f7; padding: 14px; border-radius: 12px; text-align: center; border: 1px solid rgba(0,0,0,0.03); }
            .ns-stat-val { font-size: 22px; font-weight: 800; color: var(--ns-primary); margin-top: 6px; letter-spacing: -0.5px; }
            .ns-stat-label { font-size: 12px; color: var(--ns-subtext); font-weight: 600; text-transform: uppercase; }

            .ns-input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 4px; }
            .ns-input { width: 80px; padding: 8px; border-radius: 8px; border: 1px solid var(--ns-border); text-align: center; font-size: 15px; font-weight: 600; }

            .ns-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; margin-bottom: 10px; font-size: 15px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
            .ns-btn:hover { opacity: 0.95; transform: translateY(-1px); }
            .ns-btn:active { transform: translateY(0); }

            .ns-btn-start { background: linear-gradient(135deg, #34C759, #30D158); }
            .ns-btn-stop { background: linear-gradient(135deg, #FF3B30, #FF453A); }
            .ns-btn-copy { background: linear-gradient(135deg, #007AFF, #0062CC); }
            .ns-btn-clear { background: transparent; color: var(--ns-subtext); border: 1px solid var(--ns-border); box-shadow: none; font-size: 13px; padding: 10px; }
            .ns-btn-clear:hover { background: #f5f5f7; border-color: #FF3B30; color: #FF3B30; }

            .ns-progress-wrap { margin-bottom: 10px; }
            .ns-progress { height: 6px; background: #e5e5ea; border-radius: 3px; overflow: hidden; }
            .ns-fill { height: 100%; background: var(--ns-primary); width: 0%; transition: width 0.3s ease; }
            .ns-status { text-align: center; font-size: 12px; color: var(--ns-subtext); margin-top: 6px; }

            .ns-textarea { width: 100%; height: 250px; margin: 15px 0; padding: 12px; border-radius: 12px; border: 1px solid var(--ns-border); font-family: 'Menlo', 'Monaco', monospace; font-size: 12px; resize: none; background: #fbfbfb; display: none; line-height: 1.4; color: #333; }
            .ns-textarea.show { display: block; }
        `;
        document.head.appendChild(style);
    }

    // --- 2. æ‚¬æµ®æŒ‰é’® ---
    function initBtn() {
        if (document.getElementById('ns-entry-btn')) return;
        const btn = document.createElement('div');
        btn.id = 'ns-entry-btn';
        btn.innerHTML = 'ğŸ—';
        btn.style.cssText = `
            position: fixed; bottom: 80px; right: 30px; width: 52px; height: 52px;
            background: white; border-radius: 50%; text-align: center; line-height: 52px;
            font-size: 26px; cursor: pointer; z-index: 99998;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); transition: transform 0.2s;
            border: 1px solid rgba(0,0,0,0.05); user-select: none;
        `;
        btn.onclick = () => {
            if (document.getElementById('ns-panel')) {
                document.getElementById('ns-panel').remove();
            } else {
                createControlPanel();
            }
        };
        btn.onmouseover = () => btn.style.transform = 'scale(1.1) rotate(12deg)';
        btn.onmouseout = () => btn.style.transform = 'scale(1) rotate(0deg)';
        document.body.appendChild(btn);
    }

    // --- 3. æ§åˆ¶é¢æ¿ ---
    function createControlPanel() {
        if (document.getElementById('ns-panel')) return;

        const curPage = getUrlPage();
        const detectedMax = detectTotalPages();
        const displayMax = Math.max(detectedMax, state.maxPage, 1);

        const panel = document.createElement('div');
        panel.id = 'ns-panel';
        panel.className = 'ns-panel';
        panel.innerHTML = `
            <div class="ns-header">
                <div class="ns-title">ğŸ— ç­¾åˆ°æ”¶ç›Šåˆ†æ v1.4</div>
                <div class="ns-close" id="ns-close">âœ•</div>
            </div>

            <div id="ns-config" style="${state.isRunning ? 'display:none' : ''}">
                <div class="ns-input-row">
                    <span style="font-size:14px; font-weight:600; color:#444;">è®¡åˆ’æ‰«æé¡µæ•°:</span>
                    <input type="number" id="ns-pages" class="ns-input" value="${displayMax}" min="1">
                </div>
                <div style="font-size:12px; color:#999; margin-bottom:15px; text-align:right;">*è‡ªåŠ¨æ£€æµ‹åˆ°å…± ${detectedMax} é¡µ</div>
            </div>

            <div class="ns-grid">
                <div class="ns-stat">
                    <div class="ns-stat-label">å·²é‡‡é›†ç­¾åˆ°</div>
                    <div class="ns-stat-val" id="ns-count">${allRecords.length}</div>
                </div>
                <div class="ns-stat">
                    <div class="ns-stat-label">é¡µç è¿›åº¦</div>
                    <div class="ns-stat-val" style="color:#007AFF" id="ns-page-txt">${curPage} / ${state.isRunning ? state.maxPage : displayMax}</div>
                </div>
            </div>

            <div class="ns-progress-wrap">
                <div class="ns-progress">
                    <div class="ns-fill" id="ns-bar"></div>
                </div>
                <div class="ns-status" id="ns-status">
                    ${state.isRunning ? 'æ­£åœ¨å…¨åŠ›æ‰«æä¸­...' : 'å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»å¼€å§‹'}
                </div>
            </div>

            <textarea id="ns-result-area" class="ns-textarea" readonly></textarea>

            <div id="ns-actions">
                ${state.isRunning
                    ? `<button class="ns-btn ns-btn-stop" id="ns-stop">â¹ åœæ­¢æ‰«æ</button>`
                    : `<button class="ns-btn ns-btn-start" id="ns-start">â–¶ å¼€å§‹åˆ†æ</button>`
                }
            </div>

            <div id="ns-copy-btn-area" style="display:none;">
                 <button class="ns-btn ns-btn-copy" id="ns-copy">ğŸ“„ å¤åˆ¶å®Œæ•´æŠ¥å‘Š</button>
            </div>

            <button class="ns-btn ns-btn-clear" id="ns-clear">ğŸ—‘ï¸ æ¸…ç©ºç¼“å­˜æ•°æ®</button>
        `;
        document.body.appendChild(panel);

        document.getElementById('ns-close').onclick = () => panel.remove();
        document.getElementById('ns-clear').onclick = clearData;
        const btnCopy = document.getElementById('ns-copy');
        if (btnCopy) btnCopy.onclick = copyResult;

        const btnStart = document.getElementById('ns-start');
        if(btnStart) btnStart.onclick = startExtraction;

        const btnStop = document.getElementById('ns-stop');
        if(btnStop) btnStop.onclick = stopExtraction;

        updateUI();
        if (!state.isRunning && allRecords.length > 0) showResultArea();
    }

    // --- 4. æ ¸å¿ƒé€»è¾‘ (ä¿®å¤é¡µç ä¸ç”¨æˆ·ID) ---

    // å¼ºåŒ–ç‰ˆç”¨æˆ·IDè·å–ï¼šæ‰«æé¡µé¢ä¸Šæ‰€æœ‰æŒ‡å‘ /space/xxx çš„é“¾æ¥
    function getUserInfo() {
        // å°è¯•1ï¼šä»é¡¶éƒ¨å¯¼èˆªæ æˆ–é¡µé¢ä¸­å¯»æ‰¾ä¸ªäººä¸»é¡µé“¾æ¥
        // NodeSeek çš„ä¸ªäººä¸»é¡µé“¾æ¥é€šå¸¸æ˜¯ href="/space/12345"
        // æ’é™¤æ‰å¯èƒ½æ˜¯åˆ«äººçš„é“¾æ¥ï¼ˆé€šå¸¸é¡¶éƒ¨å¯¼èˆªçš„æ˜¯è‡ªå·±çš„ï¼‰

        let foundId = '';
        let foundName = '';

        // ç­–ç•¥ï¼šå¯»æ‰¾é¡µé¢ä¸­æ‰€æœ‰çš„ /space/ é“¾æ¥
        const spaceLinks = document.querySelectorAll('a[href^="/space/"]');

        for (let link of spaceLinks) {
            const href = link.getAttribute('href');
            const match = href.match(/\/space\/(\d+)/);

            // è¿‡æ»¤æ¡ä»¶ï¼šé€šå¸¸é¡¶éƒ¨å¯¼èˆªçš„ä¸ªäººé“¾æ¥åŒ…å«å¤´åƒæˆ–ç”¨æˆ·åï¼Œæˆ–è€…ä½äºç‰¹å®šçš„å®¹å™¨ä¸­
            // ç®€å•åˆ¤æ–­ï¼šå¦‚æœè¿™ä¸ªé“¾æ¥åœ¨é¡¶éƒ¨åŒºåŸŸï¼Œæˆ–è€…åœ¨ä¾§è¾¹æ çš„ç”¨æˆ·å¡ç‰‡åŒºåŸŸ
            if (match) {
                // å¦‚æœæ˜¯åœ¨ user-card å®¹å™¨é‡Œï¼ˆå¸¸è§äºä¾§è¾¹æ ï¼‰
                if (link.closest('.user-card') || link.closest('.sidebar') || link.innerText.trim()) {
                    foundId = match[1];
                    foundName = link.innerText.trim() || "NodeSeeker";
                    // æ‰¾åˆ°ä¸€ä¸ªçœ‹èµ·æ¥åƒæ˜¯åœ¨ä¾§è¾¹æ å±•ç¤ºç”¨æˆ·ä¿¡æ¯çš„å°±åœæ­¢
                    if (link.closest('.sidebar') || link.querySelector('img')) {
                         break;
                    }
                }
            }
        }

        // ä¿åº•ç­–ç•¥ï¼šå¦‚æœ URL æœ¬èº«å°±æ˜¯ space (è™½ç„¶è„šæœ¬ä¸»è¦è¿è¡Œåœ¨ log é¡µï¼Œä½†ä»¥é˜²ä¸‡ä¸€)
        const urlMatch = window.location.href.match(/\/space\/(\d+)/);
        if (urlMatch) foundId = urlMatch[1];

        // å†æ¬¡å°è¯•è·å–åå­—ï¼Œå¦‚æœæ²¡æ‰¾åˆ°
        if (!foundName) {
            const nameEl = document.querySelector('.username');
            if (nameEl) foundName = nameEl.innerText.trim();
        }

        if (foundId && foundName) {
            return `${foundName} (UID: ${foundId})`;
        } else if (foundName) {
            return foundName;
        } else {
            return "NodeSeeker";
        }
    }

    function getUrlPage() {
        const hashMatch = window.location.hash.match(/p-(\d+)/);
        if (hashMatch) return parseInt(hashMatch[1]);
        const params = new URLSearchParams(window.location.search);
        return parseInt(params.get('page')) || 1;
    }

    function detectTotalPages() {
        const pagination = document.querySelector('.pagination') || document.querySelector('div[role="navigation"]');
        if (!pagination) return 1;
        const links = pagination.querySelectorAll('a, li, div');
        let max = 1;
        links.forEach(el => {
            const txt = el.innerText.trim().replace(/\.\./g, '');
            const num = parseInt(txt);
            if (!isNaN(num) && num > max) max = num;
        });
        return max;
    }

    function startExtraction() {
        const inputPages = parseInt(document.getElementById('ns-pages').value) || 1;
        const curPage = getUrlPage();
        const detectedMax = detectTotalPages();
        let maxTarget = Math.max(inputPages, detectedMax);

        state = {
            isRunning: true,
            startPage: curPage,
            targetPage: curPage,
            maxPage: maxTarget
        };

        allRecords = [];
        saveState();
        saveData();

        const panel = document.getElementById('ns-panel');
        if (panel) panel.remove();
        createControlPanel();
        processPage();
    }

    function stopExtraction() {
        state.isRunning = false;
        saveState();
        updateStatus("âš ï¸ å·²æš‚åœ");
        const panel = document.getElementById('ns-panel');
        if (panel) panel.remove();
        createControlPanel();
    }

    function processPage() {
        if (!state.isRunning) return;

        const currentRealMax = detectTotalPages();
        if (currentRealMax > state.maxPage) {
            state.maxPage = currentRealMax;
            saveState();
        }

        updateUI();
        updateStatus(`æ­£åœ¨æå–ç¬¬ ${state.targetPage} é¡µ / å…± ${state.maxPage} é¡µ...`);

        const records = extractTableData();
        if (records.length > 0) {
            allRecords = allRecords.concat(records);
            saveData();
        }

        if (state.targetPage < state.maxPage) {
            state.targetPage++;
            saveState();
            setTimeout(() => {
                if (window.location.hash.includes('p-')) {
                    window.location.hash = `#/p-${state.targetPage}`;
                    window.location.reload();
                } else {
                    const nextUrl = new URL(window.location.href);
                    nextUrl.searchParams.set('page', state.targetPage);
                    window.location.href = nextUrl.toString();
                }
            }, 800 + Math.random() * 600);
        } else {
            finish();
        }
    }

    function extractTableData() {
        const rows = document.querySelectorAll('table tbody tr');
        const results = [];
        rows.forEach(row => {
            const cols = row.querySelectorAll('td');
            if (cols.length < 4) return;
            const changeText = cols[0].innerText.trim();
            const reason = cols[2].innerText.trim();
            const time = cols[3].innerText.trim();
            const changeVal = parseInt(changeText);

            if (reason.includes('ç­¾åˆ°æ”¶ç›Š') && changeVal > 0 && !reason.includes('åˆ†äº«')) {
                results.push({
                    change: changeVal,
                    reason: reason,
                    time: time
                });
            }
        });
        return results;
    }

    function finish() {
        state.isRunning = false;
        saveState();
        const panel = document.getElementById('ns-panel');
        if (panel) panel.remove();
        createControlPanel();
        updateStatus("âœ¨ æ‰«æå®Œæˆï¼");
        showResultArea();
    }

    function showResultArea() {
        const txt = generateReportText();
        const area = document.getElementById('ns-result-area');
        const copyBtnDiv = document.getElementById('ns-copy-btn-area');
        const actionsDiv = document.getElementById('ns-actions');

        if (area) {
            area.value = txt;
            area.classList.add('show');
        }
        if (copyBtnDiv) copyBtnDiv.style.display = 'block';
        if (actionsDiv) actionsDiv.style.display = 'none';
    }

    function copyResult() {
        const area = document.getElementById('ns-result-area');
        if (area) {
            area.select();
            document.execCommand('copy');
            updateStatus("âœ… å·²å¤åˆ¶ï¼");
            setTimeout(() => updateStatus("âœ¨ æ‰«æå®Œæˆï¼"), 2000);
        }
    }

    // --- 5. æŠ¥å‘Šç”Ÿæˆ (é€»è¾‘å‡çº§) ---
    function generateReportText() {
        if (allRecords.length === 0) return "æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç­¾åˆ°æ”¶ç›Šæ•°æ®ã€‚";

        let total = 0;
        let max = -999;
        let min = 999;
        let luckyDays = 0; // >=8
        let superLuckyDays = 0; // >=20
        let fiveCount = 0; // ç»Ÿè®¡5é¸¡è…¿æ¬¡æ•°

        allRecords.forEach(r => {
            total += r.change;
            if (r.change > max) max = r.change;
            if (r.change < min) min = r.change;
            if (r.change >= 8) luckyDays++;
            if (r.change >= 20) superLuckyDays++;
            if (r.change === 5) fiveCount++;
        });

        const totalDays = allRecords.length;
        const avg = (total / totalDays).toFixed(2);
        const userInfo = getUserInfo(); // è·å– ID + ç”¨æˆ·å
        const rating = getRating(parseFloat(avg));

        // è®¡ç®—ç‰¹æ®Šæ´¾åˆ«
        const fivePercent = ((fiveCount / totalDays) * 100).toFixed(1);
        const isConservative = parseFloat(fivePercent) >= 50;
        const isRadical = parseFloat(fivePercent) < 50;

        let report = `=== ğŸ— NodeSeek ç­¾åˆ°è¿åŠ¿è¯¦ç»†åˆ†æ ===
ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯ï¼š${userInfo}
ğŸ“… ç»Ÿè®¡æ—¶é—´ï¼š${new Date().toLocaleString()}
ğŸ“Š ç»Ÿè®¡èŒƒå›´ï¼š${state.maxPage} é¡µ / ${totalDays} æ¬¡æœ‰æ•ˆç­¾åˆ°

ğŸ’° ã€æ”¶ç›Šç»Ÿè®¡ã€‘
   - æ€»æ”¶ç›Šï¼š${total} é¸¡è…¿
   - å¹³å‡æ¯æ—¥ï¼š${avg} é¸¡è…¿
   - å•æ—¥æœ€é«˜ï¼š${max}
   - å•æ—¥æœ€ä½ï¼š${min}

ğŸ² ã€è¿åŠ¿åˆ†æã€‘
   - ğŸŒŸ æš´å‡»å¤©æ•°(â‰¥8)ï¼š${luckyDays} å¤©
   - ğŸ›¡ï¸ ä¿åº•å¤©æ•°(5è…¿)ï¼š${fiveCount} å¤© (å æ¯” ${fivePercent}%)

ğŸ† ã€ç»¼åˆè¯„çº§ã€‘
   ${rating}`;

        // ç‰¹æ®Šç§°å·åˆ¤å®š
        if (isConservative) {
            report += `
   ğŸ›¡ï¸ ç‰¹æ®Šç§°å·ï¼šã€ç¨³å¥ä¿å®ˆæ´¾ã€‘
      (è¯´æ˜ï¼šæ‚¨æœ‰è¶…è¿‡50%çš„ç­¾åˆ°è·å¾—äº†5é¸¡è…¿ï¼Œä¸»æ‰“ä¸€ä¸ªç¨³ç¨³çš„å¹¸ç¦)`;
        } else if (isRadical) {
            report += `
   âš”ï¸ ç‰¹æ®Šç§°å·ï¼šã€æ¿€è¿›å†’é™©æ´¾ã€‘
      (è¯´æ˜ï¼šæ‚¨è·å¾—5é¸¡è…¿çš„æ¯”ä¾‹ä¸è¶³50%ï¼Œè¯´æ˜æ‚¨ç»å¸¸åœ¨æ¬§çš‡å’Œéé…‹ä¹‹é—´åå¤æ¨ªè·³ï¼Œæ‹’ç»å¹³åº¸ï¼Œæ­¤æ—¶æ— å£°èƒœæœ‰å£°ï¼)`;
        }

        report += `

ğŸ’¬ ã€AIç‚¹è¯„ã€‘
   ${getComment(parseFloat(avg), isConservative, isRadical)}

--------------------------------
ğŸ“ ã€ç­‰çº§å¯¹ç…§è¡¨ã€‘
   ğŸ‘‘ æ¬§ç¥ (God) : å¹³å‡ â‰¥ 10
   â˜€ï¸ æ¬§çš‡ (SSS) : å¹³å‡ â‰¥ 8.0
   ğŸŒ™ æ¬§æ´²äºº (S) : å¹³å‡ â‰¥ 6.5
   â˜ï¸ æ™®é€šäºº (A) : å¹³å‡ â‰¥ 5.0
   ğŸŒ§ï¸ éé…‹ (B)   : å¹³å‡ â‰¥ 4.0
   âš¡ å¤©è°´ä¹‹äºº (C): å¹³å‡ < 4.0
   ğŸ›¡ï¸ ä¿å®ˆæ´¾     : 5é¸¡è…¿å æ¯” â‰¥ 50%
   âš”ï¸ æ¿€è¿›æ´¾     : 5é¸¡è…¿å æ¯” < 50%
--------------------------------`;

        return report;
    }

    function getRating(avg) {
        if (avg >= 10) return "ğŸ‘‘ æ¬§ç¥ (God) - å¤©é€‰ä¹‹å­ï¼";
        if (avg >= 8.0) return "â˜€ï¸ æ¬§çš‡ (SSS) - è¿æ°”çˆ†æ£šï¼";
        if (avg >= 6.5) return "ğŸŒ™ æ¬§æ´²äºº (S) - ä»¤äººç¾¡æ…•ã€‚";
        if (avg >= 5.0) return "â˜ï¸ æ™®é€šäºº (A) - ä¼—ç”Ÿå¹³ç­‰ã€‚";
        if (avg >= 4.0) return "ğŸŒ§ï¸ éé…‹ (B) - ç•¥æ˜¾å°´å°¬...";
        return "âš¡ å¤©è°´ä¹‹äºº (C) - å»ºè®®é‡å¼€...";
    }

    function getComment(avg, isConservative, isRadical) {
        if (avg >= 8) return "è¿™ç§è¿æ°”å»ºè®®ç›´æ¥å»ä¹°å½©ç¥¨ï¼Œåˆ«åœ¨è¿™é‡Œæµªè´¹æ—¶é—´äº†ï¼";

        if (isRadical) {
             if (avg >= 6) return "è™½ç„¶ä¸å¸¸æ‹¿ä¿åº•ï¼Œä½†æ‚¨çš„è¿æ°”æ€»ä½“ä¾ç„¶åœ¨çº¿ï¼Œæ˜¯ä¸ªæ•¢æ‰“æ•¢æ‹¼çš„èµ¢å®¶ï¼";
             return "æ‚¨è¿™ç­¾åˆ°è®°å½•çœŸæ˜¯è·Œå®•èµ·ä¼ï¼Œçœ‹æ¥æ‚¨æ˜¯ä¸ªä¸å–œæ¬¢æŒ‰å¥—è·¯å‡ºç‰Œçš„äººï¼Œç”Ÿæ´»å°±è¯¥è¿™æ ·å……æ»¡ä¸ç¡®å®šæ€§ï¼";
        }

        if (isConservative) return "æµæ°´çš„å¤§ä½¬ï¼Œé“æ‰“çš„5é¸¡è…¿ã€‚è™½ç„¶æ²¡æœ‰æš´å¯Œï¼Œä½†èƒœåœ¨ç»†æ°´é•¿æµï¼Œç¨³å°±å®Œäº‹äº†ï¼";

        if (avg >= 5) return "å¹³å¹³æ·¡æ·¡æ‰æ˜¯çœŸï¼Œåªè¦åšæŒç­¾åˆ°ï¼Œé¸¡è…¿æ€»ä¼šæœ‰çš„ã€‚";
        return "é‚£ä¸ª...è¦ä¸å’±ä»¬å¤šå‘ç‚¹æŠ€æœ¯è´´æˆ–è€…æ•´ç‚¹æ´»å§ï¼Ÿé ç­¾åˆ°å¯èƒ½å‘ä¸äº†è´¢...";
    }

    // --- è¾…åŠ©åŠŸèƒ½ ---

    function clearData() {
        if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²æ‰«æçš„æ•°æ®å—ï¼Ÿ')) {
            allRecords = [];
            state.isRunning = false;
            state.targetPage = 1;
            saveData();
            saveState();

            const panel = document.getElementById('ns-panel');
            if (panel) panel.remove();
            createControlPanel();
        }
    }

    function updateUI() {
        const countEl = document.getElementById('ns-count');
        const pageEl = document.getElementById('ns-page-txt');
        const barEl = document.getElementById('ns-bar');

        if (countEl) countEl.innerText = allRecords.length;
        if (pageEl) pageEl.innerText = `${state.targetPage} / ${state.maxPage}`;

        if (barEl && state.maxPage > 0) {
            const total = state.maxPage - state.startPage + 1;
            const current = state.targetPage - state.startPage + 1;
            const pct = Math.min(100, Math.max(0, (current / total) * 100));
            barEl.style.width = `${pct}%`;
        }
    }

    function updateStatus(text) {
        const el = document.getElementById('ns-status');
        if (el) el.innerText = text;
    }

    function saveState() { localStorage.setItem(KEY_STATE, JSON.stringify(state)); }
    function saveData() { localStorage.setItem(KEY_DATA, JSON.stringify(allRecords)); }

})();

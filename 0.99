// ==UserScript==
// @name         NodeSeek ç­¾åˆ°è¿åŠ¿ç»Ÿè®¡
// @name:zh-CN   NodeSeek ç­¾åˆ°è¿åŠ¿ç»Ÿè®¡
// @namespace    https://www.nodeseek.com/
// @version      1.1
// @description  è‡ªåŠ¨ç»Ÿè®¡ NodeSeek å†å²ç­¾åˆ°æ•°æ®ï¼Œåˆ†ææ¬§çš‡æŒ‡æ•°ï¼Œç»˜åˆ¶æ”¶ç›Šæ›²çº¿ã€‚é€‚é… /member/log å’Œ /credit é¡µé¢ã€‚
// @author       Modified by AI
// @match        https://www.nodeseek.com/member/log*
// @match        https://nodeseek.com/member/log*
// @match        https://www.nodeseek.com/credit*
// @match        https://nodeseek.com/credit*
// @icon         https://www.nodeseek.com/static/image/favicon/android-chrome-192x192.png
// @grant        GM_setClipboard
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    const KEY_DATA = 'ns_signin_data';
    const KEY_STATE = 'ns_signin_state';

    // çŠ¶æ€ç®¡ç†
    let state = JSON.parse(localStorage.getItem(KEY_STATE)) || {
        isRunning: false,
        targetPage: 0,
        maxPage: 1,
        startPage: 1
    };
    let allRecords = JSON.parse(localStorage.getItem(KEY_DATA)) || [];

    // --- å…¥å£ ---
    window.addEventListener('load', () => {
        setTimeout(() => {
            injectStyles();
            initBtn();
            // å¦‚æœå¤„äºè¿è¡ŒçŠ¶æ€ï¼Œæ¢å¤æ§åˆ¶é¢æ¿å¹¶ç»§ç»­
            if (state.isRunning) {
                createControlPanel();
                processPage(); // é¡µé¢åŠ è½½å®Œç›´æ¥å¤„ç†å½“å‰é¡µ
            }
        }, 1500); // ç¨å¾®å¢åŠ å»¶è¿Ÿä»¥ç¡®ä¿ SPA é¡µé¢æ¸²æŸ“å®Œæˆ
    });

    // --- 1. æ ·å¼æ³¨å…¥ ---
    function injectStyles() {
        const style = document.createElement('style');
        style.innerHTML = `
            :root {
                --ns-bg: rgba(255, 255, 255, 0.95);
                --ns-primary: linear-gradient(135deg, #FF9500, #FF5E3A); /* æ©™è‰²ç³»ä»£è¡¨é¸¡è…¿ */
                --ns-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            }
            .ns-panel {
                position: fixed; top: 100px; right: 20px; width: 320px;
                background: var(--ns-bg); backdrop-filter: blur(20px);
                border: 1px solid rgba(0,0,0,0.1); border-radius: 16px;
                box-shadow: var(--ns-shadow); font-family: sans-serif;
                padding: 20px; z-index: 99999; animation: ns-pop 0.3s ease-out;
            }
            @keyframes ns-pop { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
            .ns-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
            .ns-title { font-size: 16px; font-weight: 800; color: #333; }
            .ns-close { cursor: pointer; color: #999; font-size: 20px; }
            .ns-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
            .ns-stat { background: #f5f5f7; padding: 10px; border-radius: 8px; text-align: center; }
            .ns-stat-val { font-size: 20px; font-weight: 800; color: #FF9500; margin-top: 4px; }
            .ns-stat-label { font-size: 12px; color: #666; }
            .ns-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; margin-bottom: 8px; transition: 0.2s; }
            .ns-btn:hover { opacity: 0.9; transform: scale(0.98); }
            .ns-btn-start { background: #34C759; }
            .ns-btn-stop { background: #FF3B30; }
            .ns-btn-copy { background: #007AFF; }
            .ns-btn-clear { background: #8E8E93; font-size: 12px; padding: 8px; }
            .ns-progress { height: 4px; background: #eee; border-radius: 2px; overflow: hidden; margin: 15px 0; }
            .ns-fill { height: 100%; background: #34C759; width: 0%; transition: width 0.3s; }
            .ns-input { width: 60px; padding: 4px; border-radius: 4px; border: 1px solid #ddd; text-align: center; }
        `;
        document.head.appendChild(style);
    }

    // --- 2. æ‚¬æµ®æŒ‰é’® ---
    function initBtn() {
        if (document.getElementById('ns-entry-btn')) return;
        const btn = document.createElement('div');
        btn.id = 'ns-entry-btn';
        btn.innerHTML = 'ğŸ—';
        btn.style.cssText = `
            position: fixed; bottom: 50px; right: 30px; width: 50px; height: 50px;
            background: white; border-radius: 50%; text-align: center; line-height: 50px;
            font-size: 24px; cursor: pointer; z-index: 99998;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s;
        `;
        btn.onclick = () => createControlPanel();
        btn.onmouseover = () => btn.style.transform = 'scale(1.1)';
        btn.onmouseout = () => btn.style.transform = 'scale(1)';
        document.body.appendChild(btn);
    }

    // --- 3. æ§åˆ¶é¢æ¿ ---
    function createControlPanel() {
        if (document.getElementById('ns-panel')) return;

        // è·å–å½“å‰é¡µç å’Œæ€»é¡µæ•°
        const curPage = getUrlPage();
        const detectedMax = detectTotalPages();

        const panel = document.createElement('div');
        panel.id = 'ns-panel';
        panel.className = 'ns-panel';
        panel.innerHTML = `
            <div class="ns-header">
                <div class="ns-title">ğŸ— ç­¾åˆ°è¿åŠ¿åˆ†æ</div>
                <div class="ns-close" id="ns-close">Ã—</div>
            </div>

            <div id="ns-config" style="${state.isRunning ? 'display:none' : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; font-size:14px;">
                    <span>æ‰«æé¡µæ•°:</span>
                    <input type="number" id="ns-pages" class="ns-input" value="${detectedMax > 1 ? detectedMax : 10}" min="1">
                </div>
            </div>

            <div class="ns-grid">
                <div class="ns-stat">
                    <div class="ns-stat-label">å·²æ”¶é›†ç­¾åˆ°</div>
                    <div class="ns-stat-val" id="ns-count">${allRecords.length}</div>
                </div>
                <div class="ns-stat">
                    <div class="ns-stat-label">å½“å‰/æ€»é¡µ</div>
                    <div class="ns-stat-val" style="color:#007AFF" id="ns-page-txt">${curPage}/${detectedMax}</div>
                </div>
            </div>

            <div class="ns-progress">
                <div class="ns-fill" id="ns-bar"></div>
            </div>
            <div style="text-align:center; font-size:12px; color:#888; margin-bottom:10px;" id="ns-status">å‡†å¤‡å°±ç»ª</div>

            <div id="ns-actions">
                ${state.isRunning
                    ? `<button class="ns-btn ns-btn-stop" id="ns-stop">â¹ åœæ­¢é‡‡é›†</button>`
                    : `<button class="ns-btn ns-btn-start" id="ns-start">â–¶ å¼€å§‹åˆ†æ</button>`
                }
            </div>

            <div style="margin-top:10px; display:flex; gap:5px;">
                <button class="ns-btn ns-btn-copy" id="ns-report">ğŸ“Š ç”ŸæˆæŠ¥å‘Š</button>
            </div>
            <button class="ns-btn ns-btn-clear" id="ns-clear">æ¸…ç©ºæ•°æ®</button>
        `;
        document.body.appendChild(panel);

        // ç»‘å®šäº‹ä»¶
        document.getElementById('ns-close').onclick = () => panel.remove();
        document.getElementById('ns-clear').onclick = clearData;
        document.getElementById('ns-report').onclick = generateReport;

        const btnStart = document.getElementById('ns-start');
        if(btnStart) btnStart.onclick = startExtraction;

        const btnStop = document.getElementById('ns-stop');
        if(btnStop) btnStop.onclick = stopExtraction;

        updateUI();
    }

    // --- 4. æ ¸å¿ƒé€»è¾‘ ---

    // è·å–å½“å‰URLå‚æ•°ä¸­çš„page
    function getUrlPage() {
        // ä¼˜å…ˆé€‚é… hash è·¯ç”±: /credit#/p-1
        const hashMatch = window.location.hash.match(/p-(\d+)/);
        if (hashMatch) return parseInt(hashMatch[1]);

        // é€‚é… query å‚æ•°: ?page=1
        const params = new URLSearchParams(window.location.search);
        return parseInt(params.get('page')) || 1;
    }

    // æ£€æµ‹æ€»é¡µæ•°
    function detectTotalPages() {
        // é€‚é…ä¸åŒçš„åˆ†é¡µå®¹å™¨ class
        const pagination = document.querySelector('.pagination') || document.querySelector('div[role="navigation"]');
        if (!pagination) return 1;

        // å°è¯•å¯»æ‰¾æ‰€æœ‰æ•°å­—é“¾æ¥ï¼Œå–æœ€å¤§å€¼
        const links = pagination.querySelectorAll('a, li, div');
        let max = 1;
        links.forEach(el => {
            const txt = el.innerText.trim().replace(/\.\./g, ''); // å»é™¤çœç•¥å·
            const num = parseInt(txt);
            if (!isNaN(num) && num > max) max = num;
        });
        return max;
    }

    function startExtraction() {
        const inputPages = parseInt(document.getElementById('ns-pages').value) || 10;
        const curPage = getUrlPage();
        const realMax = detectTotalPages();

        // è®¡ç®—ç›®æ ‡ç»“æŸé¡µ
        let endPage = curPage + inputPages - 1;
        if (realMax > 0 && endPage > realMax) endPage = realMax;

        state = {
            isRunning: true,
            startPage: curPage,
            targetPage: curPage,
            maxPage: endPage
        };

        saveState();
        allRecords = []; // å¼€å§‹æ–°ä»»åŠ¡æ—¶æ¸…ç©ºæ—§æ•°æ®
        saveData();

        refreshPanel(); // åˆ·æ–°æŒ‰é’®çŠ¶æ€
        processPage();
    }

    function stopExtraction() {
        state.isRunning = false;
        saveState();
        refreshPanel();
        updateStatus("å·²æš‚åœ");
    }

    function processPage() {
        // æ£€æŸ¥æ˜¯å¦åœ¨è¿è¡Œ
        if (!state.isRunning) return;

        updateUI();
        updateStatus(`æ­£åœ¨åˆ†æç¬¬ ${state.targetPage} é¡µ...`);

        // æå–æ•°æ®
        const records = extractTableData();
        if (records.length > 0) {
            allRecords = allRecords.concat(records);
            saveData();
        }

        // åˆ¤æ–­ç¿»é¡µ
        if (state.targetPage < state.maxPage) {
            state.targetPage++;
            saveState();

            updateStatus(`è·³è½¬ç¬¬ ${state.targetPage} é¡µ...`);

            // å»¶è¿Ÿè·³è½¬ï¼Œæ ¹æ® URL ç±»å‹ä½¿ç”¨ä¸åŒçš„è·³è½¬æ–¹å¼
            setTimeout(() => {
                if (window.location.hash.includes('p-')) {
                    // Hash è·¯ç”±è·³è½¬ (credit é¡µé¢)
                    window.location.hash = `#/p-${state.targetPage}`;
                    // å¼ºåˆ¶åˆ·æ–°ä»¥ç¡®ä¿æ•°æ®åŠ è½½ (ç®€å•ç²—æš´ä½†æœ‰æ•ˆ)
                    window.location.reload();
                } else {
                    // Search å‚æ•°è·³è½¬ (member/log é¡µé¢)
                    const nextUrl = new URL(window.location.href);
                    nextUrl.searchParams.set('page', state.targetPage);
                    window.location.href = nextUrl.toString();
                }
            }, 800 + Math.random() * 500);
        } else {
            finish();
        }
    }

    function extractTableData() {
        const rows = document.querySelectorAll('table tbody tr');
        const results = [];

        rows.forEach(row => {
            const cols = row.querySelectorAll('td');
            if (cols.length < 4) return;

            // 1. å˜åŠ¨
            const changeText = cols[0].innerText.trim();
            // 2. ç†ç”±
            const reason = cols[2].innerText.trim();
            // 3. æ—¶é—´
            const time = cols[3].innerText.trim();

            // è¿‡æ»¤ï¼šåªç»Ÿè®¡åŒ…å«â€œç­¾åˆ°â€çš„è®°å½•
            if (reason.includes('ç­¾åˆ°')) {
                results.push({
                    change: parseInt(changeText),
                    reason: reason,
                    time: time
                });
            }
        });
        return results;
    }

    function finish() {
        state.isRunning = false;
        saveState();
        refreshPanel();
        updateStatus("âœ¨ åˆ†æå®Œæˆ");
        generateReport(); // è‡ªåŠ¨å¼¹å‡ºæŠ¥å‘Š
    }

    // --- 5. æŠ¥å‘Šç”Ÿæˆä¸è¯„åˆ† ---

    function getRating(avg) {
        if (avg >= 9.5) return "SSS (å¤©é€‰ä¹‹å­)";
        if (avg >= 8.5) return "SS (æ¬§çš‡è½¬ä¸–)";
        if (avg >= 7.0) return "S (è¿æ°”çˆ†æ£š)";
        if (avg >= 6.0) return "A (ä»¤äººç¾¡æ…•)";
        if (avg >= 5.0) return "B (å¹³å¹³æ— å¥‡)";
        if (avg >= 4.0) return "C (ç•¥æ˜¾éé…‹)";
        if (avg >= 2.0) return "D (éé…‹æœ¬é…‹)";
        return "E (å»ºè®®é‡å¼€)";
    }

    function generateReport() {
        if (allRecords.length === 0) {
            alert('è¿˜æ²¡æœ‰é‡‡é›†åˆ°ç­¾åˆ°æ•°æ®ï¼è¯·å…ˆç‚¹å‡»â€œå¼€å§‹åˆ†æâ€ã€‚');
            return;
        }

        let total = 0;
        let max = -999;
        let min = 999;
        let luckyDays = 0; // å¤§é¸¡è…¿å¤©æ•°

        // ç®€å•ç»Ÿè®¡
        allRecords.forEach(r => {
            total += r.change;
            if (r.change > max) max = r.change;
            if (r.change < min) min = r.change;
            if (r.change >= 8) luckyDays++; // å‡è®¾8ä¸ªä»¥ä¸Šç®—å¤§é¸¡è…¿
        });

        const avg = (total / allRecords.length).toFixed(2);
        const rating = getRating(parseFloat(avg));
        const username = document.querySelector('.nav-link.username')?.innerText || document.querySelector('.username')?.innerText || 'Mjj';

        const report = `
# ğŸ— NodeSeek ç­¾åˆ°è¿åŠ¿æŠ¥å‘Š

**ç”¨æˆ·**: ${username}
**åˆ†ææ—¶é—´**: ${new Date().toLocaleString()}
**ç»Ÿè®¡èŒƒå›´**: æœ€è¿‘ ${allRecords.length} æ¬¡ç­¾åˆ°

---

## ğŸ† æ ¸å¿ƒè¯„çº§: ${rating}

## ğŸ“Š è¯¦ç»†æ•°æ®
- **ç­¾åˆ°æ€»æ”¶ç›Š**: ${total} ä¸ªé¸¡è…¿
- **å¹³å‡æ¯æ¬¡**: ${avg} ä¸ª
- **å†å²æœ€é«˜**: ${max} ä¸ª
- **å†å²æœ€ä½**: ${min} ä¸ª
- **çˆ†å‘æ¬¡æ•°**: ${luckyDays} æ¬¡ (å•æ¬¡â‰¥8)

## ğŸ’¡ è¯„ä»·
${getComment(parseFloat(avg))}

---
*Generated by NodeSeek Sign-in UserScript*
`;

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        navigator.clipboard.writeText(report).then(() => {
            alert('æŠ¥å‘Šå·²ç”Ÿæˆå¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' + report);
        });
    }

    function getComment(avg) {
        if (avg > 7) return "å¤§ä½¬ï¼Œæ‚¨çš„ç­¾åˆ°è¿æ°”ç®€ç›´é€†å¤©ï¼Œå»ºè®®å»ä¹°å½©ç¥¨ï¼";
        if (avg > 5) return "æ‚¨çš„è¿æ°”å±äºä¸­ç­‰åä¸Šï¼Œç¨³æ‰ç¨³æ‰“ï¼Œé¸¡è…¿è‡ªç”±æŒ‡æ—¥å¯å¾…ã€‚";
        return "é‚£ä¸ª...è¦ä¸å’±ä»¬è¿˜æ˜¯é å‘å¸–å›å¸–èµšé¸¡è…¿å§ï¼Ÿç­¾åˆ°å¯èƒ½ä¸å¤ªé€‚åˆæ‚¨...";
    }

    // --- è¾…åŠ©åŠŸèƒ½ ---

    function clearData() {
        if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿ')) {
            allRecords = [];
            saveData();
            updateUI();
        }
    }

    function refreshPanel() {
        const panel = document.getElementById('ns-panel');
        if (panel) {
            panel.remove();
            createControlPanel();
        }
    }

    function updateUI() {
        const countEl = document.getElementById('ns-count');
        const pageEl = document.getElementById('ns-page-txt');
        const statusEl = document.getElementById('ns-status');
        const barEl = document.getElementById('ns-bar');

        if (countEl) countEl.innerText = allRecords.length;
        if (pageEl) pageEl.innerText = `${state.targetPage} / ${state.maxPage}`;
        if (statusEl) statusEl.innerText = state.isRunning ? "æ­£åœ¨é‡‡é›†..." : "å¾…æœºä¸­";

        if (barEl && state.maxPage > 0) {
            const total = state.maxPage - state.startPage + 1;
            const current = state.targetPage - state.startPage + 1;
            const pct = Math.min(100, Math.max(0, (current / total) * 100));
            barEl.style.width = `${pct}%`;
        }
    }

    function updateStatus(text) {
        const el = document.getElementById('ns-status');
        if (el) el.innerText = text;
    }

    function saveState() { localStorage.setItem(KEY_STATE, JSON.stringify(state)); }
    function saveData() { localStorage.setItem(KEY_DATA, JSON.stringify(allRecords)); }

})();

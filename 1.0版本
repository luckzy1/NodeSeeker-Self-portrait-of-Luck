// ==UserScript==
// @name         NodeSeek ç­¾åˆ°è¿åŠ¿ç»Ÿè®¡
// @name:zh-CN   NodeSeek ç­¾åˆ°è¿åŠ¿ç»Ÿè®¡
// @namespace    https://www.nodeseek.com/
// @version      1.2
// @description  è‡ªåŠ¨ç»Ÿè®¡ NodeSeek å†å²ç­¾åˆ°æ•°æ®ï¼Œåˆ†ææ¬§çš‡æŒ‡æ•°ã€‚ä¸¥æ ¼è¿‡æ»¤â€œç­¾åˆ°æ”¶ç›Šâ€ï¼Œæ’é™¤è´Ÿæ•°å’Œæ— å…³è®°å½•ã€‚
// @author       Modified by AI
// @match        https://www.nodeseek.com/member/log*
// @match        https://nodeseek.com/member/log*
// @match        https://www.nodeseek.com/credit*
// @match        https://nodeseek.com/credit*
// @icon         https://www.nodeseek.com/static/image/favicon/android-chrome-192x192.png
// @grant        GM_setClipboard
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    const KEY_DATA = 'ns_signin_data_v2'; // å‡çº§Keyé˜²æ­¢æ—§æ•°æ®å¹²æ‰°
    const KEY_STATE = 'ns_signin_state_v2';

    // çŠ¶æ€ç®¡ç†
    let state = JSON.parse(localStorage.getItem(KEY_STATE)) || {
        isRunning: false,
        targetPage: 0,
        maxPage: 1,
        startPage: 1
    };
    let allRecords = JSON.parse(localStorage.getItem(KEY_DATA)) || [];

    // --- å…¥å£ ---
    window.addEventListener('load', () => {
        // ç¨å¾®å»¶è¿Ÿä»¥ç¡®ä¿é¡µé¢å…ƒç´ åŠ è½½å®Œæ¯•
        setTimeout(() => {
            injectStyles();
            initBtn();
            if (state.isRunning) {
                createControlPanel();
                // é¡µé¢åŠ è½½åç«‹å³æ£€æŸ¥å¹¶å¤„ç†
                processPage();
            }
        }, 1500);
    });

    // --- 1. æ ·å¼æ³¨å…¥ ---
    function injectStyles() {
        if (document.getElementById('ns-style')) return;
        const style = document.createElement('style');
        style.id = 'ns-style';
        style.innerHTML = `
            :root {
                --ns-bg: rgba(255, 255, 255, 0.98);
                --ns-primary: #FF9500;
                --ns-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            }
            .ns-panel {
                position: fixed; top: 100px; right: 20px; width: 340px;
                background: var(--ns-bg); backdrop-filter: blur(10px);
                border: 1px solid rgba(0,0,0,0.08); border-radius: 16px;
                box-shadow: var(--ns-shadow); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                padding: 20px; z-index: 99999; display: flex; flex-direction: column;
                animation: ns-fade 0.3s ease-out;
            }
            @keyframes ns-fade { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
            .ns-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
            .ns-title { font-size: 16px; font-weight: 700; color: #1d1d1f; }
            .ns-close { cursor: pointer; color: #86868b; font-size: 20px; transition: 0.2s; }
            .ns-close:hover { color: #333; }

            .ns-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
            .ns-stat { background: #f5f5f7; padding: 12px; border-radius: 10px; text-align: center; }
            .ns-stat-val { font-size: 20px; font-weight: 700; color: var(--ns-primary); margin-top: 4px; }
            .ns-stat-label { font-size: 11px; color: #86868b; font-weight: 500; }

            .ns-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; margin-bottom: 8px; font-size: 14px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
            .ns-btn:hover { opacity: 0.9; transform: translateY(-1px); }
            .ns-btn:active { transform: translateY(0); }
            .ns-btn-start { background: linear-gradient(135deg, #34C759, #30D158); box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3); }
            .ns-btn-stop { background: linear-gradient(135deg, #FF3B30, #FF453A); }
            .ns-btn-copy { background: linear-gradient(135deg, #007AFF, #0062CC); box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); }
            .ns-btn-clear { background: transparent; color: #86868b; border: 1px solid #e5e5ea; font-size: 12px; padding: 8px; box-shadow: none; }
            .ns-btn-clear:hover { background: #f5f5f7; color: #FF3B30; border-color: #FF3B30; }

            .ns-progress { height: 6px; background: #e5e5ea; border-radius: 3px; overflow: hidden; margin: 15px 0 8px 0; }
            .ns-fill { height: 100%; background: var(--ns-primary); width: 0%; transition: width 0.3s ease; }

            .ns-input { width: 70px; padding: 6px; border-radius: 8px; border: 1px solid #d2d2d7; text-align: center; font-size: 14px; font-weight: 600; color: #333; }
            .ns-input:focus { outline: none; border-color: #007AFF; }

            .ns-textarea { width: 100%; height: 120px; margin: 10px 0; padding: 10px; border-radius: 8px; border: 1px solid #d2d2d7; font-family: monospace; font-size: 12px; resize: none; background: #fbfbfb; display: none; }
            .ns-textarea.show { display: block; }
        `;
        document.head.appendChild(style);
    }

    // --- 2. æ‚¬æµ®æŒ‰é’® ---
    function initBtn() {
        if (document.getElementById('ns-entry-btn')) return;
        const btn = document.createElement('div');
        btn.id = 'ns-entry-btn';
        btn.innerHTML = 'ğŸ—';
        btn.style.cssText = `
            position: fixed; bottom: 80px; right: 30px; width: 48px; height: 48px;
            background: white; border-radius: 50%; text-align: center; line-height: 48px;
            font-size: 24px; cursor: pointer; z-index: 99998;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); transition: transform 0.2s;
            border: 1px solid rgba(0,0,0,0.05); user-select: none;
        `;
        btn.onclick = () => {
            if (document.getElementById('ns-panel')) {
                document.getElementById('ns-panel').remove();
            } else {
                createControlPanel();
            }
        };
        btn.onmouseover = () => btn.style.transform = 'scale(1.1) rotate(10deg)';
        btn.onmouseout = () => btn.style.transform = 'scale(1) rotate(0deg)';
        document.body.appendChild(btn);
    }

    // --- 3. æ§åˆ¶é¢æ¿ ---
    function createControlPanel() {
        if (document.getElementById('ns-panel')) return;

        const curPage = getUrlPage();
        const detectedMax = detectTotalPages();
        const displayMax = detectedMax > 1 ? detectedMax : (state.maxPage > 1 ? state.maxPage : 10);

        const panel = document.createElement('div');
        panel.id = 'ns-panel';
        panel.className = 'ns-panel';
        panel.innerHTML = `
            <div class="ns-header">
                <div class="ns-title">ğŸ“Š ç­¾åˆ°æ”¶ç›Šç»Ÿè®¡ v1.2</div>
                <div class="ns-close" id="ns-close">âœ•</div>
            </div>

            <div id="ns-config" style="${state.isRunning ? 'display:none' : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding: 0 5px;">
                    <span style="font-size:14px; font-weight:500; color:#333;">æ‰«ææ€»é¡µæ•°:</span>
                    <input type="number" id="ns-pages" class="ns-input" value="${displayMax}" min="1">
                </div>
            </div>

            <div class="ns-grid">
                <div class="ns-stat">
                    <div class="ns-stat-label">æœ‰æ•ˆç­¾åˆ°(å¤©)</div>
                    <div class="ns-stat-val" id="ns-count">${allRecords.length}</div>
                </div>
                <div class="ns-stat">
                    <div class="ns-stat-label">å½“å‰è¿›åº¦</div>
                    <div class="ns-stat-val" style="color:#007AFF" id="ns-page-txt">${curPage} / ${state.isRunning ? state.maxPage : displayMax}</div>
                </div>
            </div>

            <div class="ns-progress">
                <div class="ns-fill" id="ns-bar"></div>
            </div>
            <div style="text-align:center; font-size:12px; color:#86868b; margin-bottom:12px;" id="ns-status">
                ${state.isRunning ? 'æ­£åœ¨æ‰«ææ•°æ®...' : 'å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»å¼€å§‹'}
            </div>

            <textarea id="ns-result-area" class="ns-textarea" readonly placeholder="åˆ†æå®Œæˆåç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>

            <div id="ns-actions">
                ${state.isRunning
                    ? `<button class="ns-btn ns-btn-stop" id="ns-stop">â¹ åœæ­¢æ‰«æ</button>`
                    : `<button class="ns-btn ns-btn-start" id="ns-start">â–¶ å¼€å§‹ç»Ÿè®¡</button>`
                }
            </div>

            <div id="ns-copy-btn-area" style="display:none;">
                 <button class="ns-btn ns-btn-copy" id="ns-copy">ğŸ“„ å¤åˆ¶ç»“æœ</button>
            </div>

            <button class="ns-btn ns-btn-clear" id="ns-clear">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
        `;
        document.body.appendChild(panel);

        // ç»‘å®šäº‹ä»¶
        document.getElementById('ns-close').onclick = () => panel.remove();
        document.getElementById('ns-clear').onclick = clearData;

        // ç»‘å®šå¤åˆ¶
        const btnCopy = document.getElementById('ns-copy');
        if (btnCopy) btnCopy.onclick = copyResult;

        const btnStart = document.getElementById('ns-start');
        if(btnStart) btnStart.onclick = startExtraction;

        const btnStop = document.getElementById('ns-stop');
        if(btnStop) btnStop.onclick = stopExtraction;

        updateUI();

        // å¦‚æœå·²ç»æœ‰ç»“æœï¼Œæ˜¾ç¤ºå‡ºæ¥
        if (!state.isRunning && allRecords.length > 0) {
             showResultArea();
        }
    }

    // --- 4. æ ¸å¿ƒé€»è¾‘ ---

    function getUrlPage() {
        const hashMatch = window.location.hash.match(/p-(\d+)/);
        if (hashMatch) return parseInt(hashMatch[1]);
        const params = new URLSearchParams(window.location.search);
        return parseInt(params.get('page')) || 1;
    }

    function detectTotalPages() {
        const pagination = document.querySelector('.pagination') || document.querySelector('div[role="navigation"]');
        if (!pagination) return 1;
        const links = pagination.querySelectorAll('a, li, div');
        let max = 1;
        links.forEach(el => {
            const txt = el.innerText.trim().replace(/\.\./g, '');
            const num = parseInt(txt);
            if (!isNaN(num) && num > max) max = num;
        });
        return max;
    }

    function startExtraction() {
        const inputPages = parseInt(document.getElementById('ns-pages').value) || 1;
        const curPage = getUrlPage();
        const realMax = detectTotalPages();

        // é€»è¾‘ï¼šå¦‚æœå½“å‰æ˜¯ç¬¬1é¡µï¼Œä¸”è¾“å…¥äº†62ï¼Œåˆ™ç›®æ ‡å°±æ˜¯62ã€‚
        // å¦‚æœå½“å‰æ˜¯ç¬¬10é¡µï¼Œè¾“å…¥äº†10ï¼Œåˆ™ç›®æ ‡æ˜¯20ã€‚
        // é€šå¸¸ç”¨æˆ·è¾“å…¥çš„æ˜¯â€œæ€»é¡µæ•°â€ï¼Œæ‰€ä»¥æˆ‘ä»¬å–è¾ƒå¤§å€¼ã€‚
        let maxTarget = inputPages;
        if (realMax > maxTarget) maxTarget = realMax;

        state = {
            isRunning: true,
            startPage: curPage,
            targetPage: curPage,
            maxPage: maxTarget
        };

        allRecords = [];
        saveState();
        saveData();

        // åˆ·æ–°é¢æ¿ä»¥æ˜¾ç¤ºåœæ­¢æŒ‰é’®
        const panel = document.getElementById('ns-panel');
        if (panel) panel.remove();
        createControlPanel();

        processPage();
    }

    function stopExtraction() {
        state.isRunning = false;
        saveState();
        updateStatus("âš ï¸ å·²æ‰‹åŠ¨æš‚åœ");
        const panel = document.getElementById('ns-panel');
        if (panel) panel.remove();
        createControlPanel();
    }

    function processPage() {
        if (!state.isRunning) return;

        updateUI();
        updateStatus(`æ­£åœ¨æ‰«æç¬¬ ${state.targetPage} é¡µ...`);

        // æå–æ•°æ®
        const records = extractTableData();
        if (records.length > 0) {
            allRecords = allRecords.concat(records);
            saveData();
        }

        // ç¿»é¡µé€»è¾‘
        if (state.targetPage < state.maxPage) {
            state.targetPage++;
            saveState();

            setTimeout(() => {
                if (window.location.hash.includes('p-')) {
                    window.location.hash = `#/p-${state.targetPage}`;
                    window.location.reload();
                } else {
                    const nextUrl = new URL(window.location.href);
                    nextUrl.searchParams.set('page', state.targetPage);
                    window.location.href = nextUrl.toString();
                }
            }, 800 + Math.random() * 500);
        } else {
            // å·²ç»æ˜¯æœ€åä¸€é¡µï¼Œä¸”å·²å®Œæˆæ•°æ®æå–
            finish();
        }
    }

    function extractTableData() {
        const rows = document.querySelectorAll('table tbody tr');
        const results = [];

        rows.forEach(row => {
            const cols = row.querySelectorAll('td');
            if (cols.length < 4) return;

            const changeText = cols[0].innerText.trim();
            const reason = cols[2].innerText.trim();
            const time = cols[3].innerText.trim();
            const changeVal = parseInt(changeText);

            // æ ¸å¿ƒè¿‡æ»¤é€»è¾‘ï¼š
            // 1. ç†ç”±å¿…é¡»åŒ…å« "ç­¾åˆ°æ”¶ç›Š"
            // 2. å˜åŠ¨å€¼å¿…é¡» > 0 (æ’é™¤è´Ÿæ•°)
            // 3. æ’é™¤ "åˆ†äº«è´´" (è™½ç„¶ç­¾åˆ°æ”¶ç›Šé€šå¸¸ä¸å«è¿™ä¸ªï¼Œä½†åŠ ä¸ªä¿é™©)
            if (reason.includes('ç­¾åˆ°æ”¶ç›Š') && changeVal > 0 && !reason.includes('åˆ†äº«')) {
                results.push({
                    change: changeVal,
                    reason: reason,
                    time: time
                });
            }
        });
        return results;
    }

    function finish() {
        state.isRunning = false;
        saveState();

        const panel = document.getElementById('ns-panel');
        if (panel) panel.remove();
        createControlPanel();

        updateStatus("âœ¨ æ‰«æå®Œæˆï¼");
        showResultArea();
    }

    function showResultArea() {
        const txt = generateReportText();
        const area = document.getElementById('ns-result-area');
        const copyBtnDiv = document.getElementById('ns-copy-btn-area');
        const actionsDiv = document.getElementById('ns-actions');

        if (area) {
            area.value = txt;
            area.classList.add('show');
        }
        if (copyBtnDiv) copyBtnDiv.style.display = 'block';
        if (actionsDiv) actionsDiv.style.display = 'none'; // éšè—å¼€å§‹æŒ‰é’®ï¼Œé¿å…è¯¯è§¦
    }

    function copyResult() {
        const area = document.getElementById('ns-result-area');
        if (area) {
            area.select();
            document.execCommand('copy');
            updateStatus("âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
            setTimeout(() => updateStatus("âœ¨ æ‰«æå®Œæˆï¼"), 2000);
        }
    }

    // --- 5. æŠ¥å‘Šç”Ÿæˆ ---
    function generateReportText() {
        if (allRecords.length === 0) return "æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç­¾åˆ°æ”¶ç›Šæ•°æ®ã€‚";

        let total = 0;
        let max = -999;
        let min = 999;
        let luckyDays = 0; // >=8
        let superLuckyDays = 0; // >=20 (æš´å‡»)

        allRecords.forEach(r => {
            total += r.change;
            if (r.change > max) max = r.change;
            if (r.change < min) min = r.change;
            if (r.change >= 8) luckyDays++;
            if (r.change >= 20) superLuckyDays++;
        });

        const avg = (total / allRecords.length).toFixed(2);
        const username = document.querySelector('.nav-link.username')?.innerText || document.querySelector('.username')?.innerText || 'NodeSeeker';
        const rating = getRating(parseFloat(avg));

        return `=== ğŸ— NodeSeek ç­¾åˆ°è¿åŠ¿ç»Ÿè®¡ ===
ğŸ‘¤ ç”¨æˆ·IDï¼š${username}
ğŸ“… ç»Ÿè®¡æ—¶é—´ï¼š${new Date().toLocaleDateString()}
ğŸ“„ ç»Ÿè®¡é¡µæ•°ï¼š${state.maxPage} é¡µ
ğŸ“ æœ‰æ•ˆç­¾åˆ°ï¼š${allRecords.length} å¤©

ğŸ’° é¸¡è…¿æ€»æ”¶ç›Šï¼š${total}
ğŸ“ˆ å¹³å‡æ¯æ—¥ï¼š${avg}
ğŸ”¼ å•æ—¥æœ€é«˜ï¼š${max}
ğŸ”½ å•æ—¥æœ€ä½ï¼š${min}

ğŸ† è¿åŠ¿è¯„çº§ï¼š${rating}
âœ¨ æ¬§çš‡æ—¶åˆ»(â‰¥8)ï¼š${luckyDays} æ¬¡
ğŸŒŸ å¥‡è¿¹æ—¶åˆ»(â‰¥20)ï¼š${superLuckyDays} æ¬¡

ğŸ’¬ è¯„è¯­ï¼š${getComment(parseFloat(avg))}`;
    }

    function getRating(avg) {
        if (avg >= 10) return "ğŸ‘‘ æ¬§ç¥ (God)";
        if (avg >= 8.0) return "â˜€ï¸ æ¬§çš‡ (SSS)";
        if (avg >= 6.5) return "ğŸŒ™ æ¬§æ´²äºº (S)";
        if (avg >= 5.0) return "â˜ï¸ æ™®é€šäºº (A)";
        if (avg >= 4.0) return "ğŸŒ§ï¸ éé…‹ (B)";
        return "âš¡ å¤©è°´ä¹‹äºº (C)";
    }

    function getComment(avg) {
        if (avg >= 8) return "å»ºè®®å‡ºé—¨å·¦è½¬ä¹°å½©ç¥¨ï¼Œè¿™è¿æ°”æ²¡è°äº†ï¼";
        if (avg >= 6) return "è¿æ°”å¾ˆæ£’ï¼Œä¿æŒç­¾åˆ°å°±æ˜¯èƒœåˆ©ï¼";
        if (avg >= 4) return "å¹³å¹³æ·¡æ·¡æ‰æ˜¯çœŸï¼Œæ”’é¸¡è…¿ä¸å®¹æ˜“å•Šã€‚";
        return "ç­”åº”æˆ‘ï¼Œå’±ä»¬è¿˜æ˜¯é å‘å¸–èµšé’±å§...";
    }

    // --- è¾…åŠ©åŠŸèƒ½ ---

    function clearData() {
        if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²æ‰«æçš„æ•°æ®å—ï¼Ÿ')) {
            allRecords = [];
            state.isRunning = false;
            state.targetPage = 1;
            saveData();
            saveState();

            const panel = document.getElementById('ns-panel');
            if (panel) panel.remove();
            createControlPanel();
            updateStatus("ğŸ—‘ï¸ æ•°æ®å·²æ¸…ç©º");
        }
    }

    function updateUI() {
        const countEl = document.getElementById('ns-count');
        const pageEl = document.getElementById('ns-page-txt');
        const barEl = document.getElementById('ns-bar');

        if (countEl) countEl.innerText = allRecords.length;
        if (pageEl) pageEl.innerText = `${state.targetPage} / ${state.maxPage}`;

        if (barEl && state.maxPage > 0) {
            const total = state.maxPage - state.startPage + 1;
            const current = state.targetPage - state.startPage + 1;
            // ç¨å¾®å¹³æ»‘ä¸€ç‚¹çš„è¿›åº¦æ¡
            const pct = Math.min(100, Math.max(0, (current / total) * 100));
            barEl.style.width = `${pct}%`;
        }
    }

    function updateStatus(text) {
        const el = document.getElementById('ns-status');
        if (el) el.innerText = text;
    }

    function saveState() { localStorage.setItem(KEY_STATE, JSON.stringify(state)); }
    function saveData() { localStorage.setItem(KEY_DATA, JSON.stringify(allRecords)); }

})();
